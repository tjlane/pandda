{% macro basic_panel(panel_data, div_name=None) -%}
<div class="panel panel-{{ panel_data.colour | default('primary') }}">
  <div class="panel-heading">
    {% if panel_data.title %}
    <h3 class="panel-title">
      {% if div_name -%}
      <a data-toggle="collapse" href="#{{ div_name }}">{{ panel_data.title }}</a>
      {% else -%}
      {{ panel_data.title }}
      {% endif -%}
    </h3>
    {% endif -%}
  </div>
  <div {% if div_name %}id="{{ div_name }}" class="panel-collapse collapse {% if panel_data.show|default(true) %}in{% endif %}"{% endif %}>
    <div class="panel-body">
      <div class="row row-centered">
      {% for obj in panel_data.body -%}
        <div class="col col-centered col-xs-12 col-md-{{ obj.width | default(12) }}">
            <div {% if (obj.type or obj.classes) %}class="{% for c in obj.classes %}{{c}} {% endfor %} {% if obj.type %}{{obj.type}} {{obj.type}}-{{obj.colour | default('primary')}}{% endif %}"{% endif %}>
          {% if obj.title is defined %}
            <h4>{{ obj.title }}</h4>
          {% endif %}
          {% if obj.text is defined %}
            <p>{{ obj.text }}</p>
          {% endif %}
          {% if obj.image is defined %}
            <a href="#" class="thumbnail" data-toggle="modal" data-target="#lightbox">
              <img class="img-responsive" src="{{ obj.image }}" alt="No Image">
            </a>
          {% endif %}
          {% if obj.table is defined %}
            <div class="table-responsive">
              {{ obj.table }}
            </div>
          {% endif %}
          {% for div in obj.divs %}
            <div id="{{ div.id }}" {% if div.classes %}class="{% for c in div.classes %}{{c}} {% endfor %}"{% endif %}>
            </div>
          {% endfor %}
          </div>
        </div>
        {% endfor -%} 
      </div>
    </div>
  </div>
</div>
{%- endmacro %}
    
{% macro lightbox_setup(id='lightbox') %}
    <style>
      #{{ id }} .modal-content {
          display: inline-block;
          text-align: center;
      }

      #{{ id }} .close {
          opacity: 1;
          color: rgb(255, 255, 255);
          background-color: rgb(25, 25, 25);
          padding: 5px 8px;
          border-radius: 30px;
          border: 2px solid rgb(255, 255, 255);
          position: absolute;
          top: -15px;
          right: -55px;

          z-index:1032;
      }
    </style>

    <script type="text/javascript" class="init">
      $(document).ready(function() {
        var $lightbox = $('#{{ id }}');
        $('[data-target="#{{ id }}"]').on('click', function(event) {
          var $img = $(this).find('img'),
          src = $img.attr('src'),
          alt = $img.attr('alt'),
          css = {
            'maxWidth': $(window).width() - 100,
            'maxHeight': $(window).height() - 100
          };
          $lightbox.find('.close').addClass('hidden');
          $lightbox.find('img').attr('src', src);
          $lightbox.find('img').attr('alt', alt);
          $lightbox.find('img').css(css);
        });
        $lightbox.on('shown.bs.modal', function (e) {
          var $img = $lightbox.find('img');    
          $lightbox.find('.modal-dialog').css({'width': $img.width()});
          $lightbox.find('.close').removeClass('hidden');
        });
      });
    </script>
{% endmacro %}

{% macro lightbox_div(id='lightbox') %}
<div id="{{ id }}" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <button type="button" class="close hidden" data-dismiss="modal" aria-hidden="true">-</button>
    <div class="modal-content">
      <div class="modal-body">
        <img src="" alt="" />
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro json_plot(plot) %}
<script type="text/javascript" class="init">
  $(document).ready(function() {
    plot_data = {{ plot.json }}

    function rescaleToInterval(data, tmin=1, tmax=20) {
      var dmin = Math.min.apply(null, data),
          dmax = Math.max.apply(null, data);
      var normed = data.map(function(x) { return ((x-dmin)*(tmax-tmin)/(dmax-dmin))+tmin; });
      return normed
    }

    function makeTrace(ix,iy) {
      return {
        x: plot_data['data'][ix],
        y: plot_data['data'][iy],
        mode: 'markers',
        type: 'scatter',
        line: {
          shape: 'marker' ,
          color: 'blue'
        },
        text: plot_data['columns'],
      };
    }
    
    function makeSelectAxisButtons(ax) {
      var buttons = [];
      buttons.push({
        method: '',
        args: [],
        label: 'Select '+ax.toUpperCase()+' Axis'
      });
      for (i=0; i < plot_data['index'].length; i++) {
        buttons.push({
          method: 'update',
          args: [{[ax]: [plot_data['data'][i]]},
                 {[ax+'axis']: {'title': plot_data['index'][i]}}],
          label: plot_data['index'][i]
        });
      }
      return buttons;
    }
    
    function makeSelectColourButtons() {
      var buttons = [];
      buttons.push({
        method: '',
        args: [],
        label: 'Select Marker Size'
      }); 
      buttons.push({
        method: 'restyle',
        args: ['marker.size', 5],
        label: 'Fixed (Default)'
      }); 
      for (i=0; i < plot_data['index'].length; i++) {
        buttons.push({
          method: 'restyle',
          args: ['marker.size', [rescaleToInterval(plot_data['data'][i])]],
          label: plot_data['index'][i]
        });
      }
      return buttons; 
    }
  
    function makeLayout(ix,iy) {
      return {
        xaxis: {title: plot_data['index'][ix]},
        yaxis: {title: plot_data['index'][iy]},
        autosize: false,
        width: 1100,
        height: 500,
        margin: {t: 20, r:300},
        hovermode: 'closest',
        annotations: [
          {text:'', x:1.1, y:0.9, xanchor:'left', yanchor:'bottom', xref:'paper', yref:'paper', showarrow:false},
          {text:'', x:1.1, y:0.7, xanchor:'left', yanchor:'bottom', xref:'paper', yref:'paper', showarrow:false},
          {text:'', x:1.1, y:0.5, xanchor:'left', yanchor:'bottom', xref:'paper', yref:'paper', showarrow:false}
        ],
        updatemenus: [
          {x: 1.1, y: 0.90, xanchor: 'left', yanchor: 'top', buttons: makeSelectAxisButtons('x')}, 
          {x: 1.1, y: 0.75, xanchor: 'left', yanchor: 'top', buttons: makeSelectAxisButtons('y')},
          {x: 1.1, y: 0.60, xanchor: 'left', yanchor: 'top', buttons: makeSelectColourButtons()}
        ]
      }
    } 

    function makePlot(ix, iy) {
        trace = makeTrace(ix=ix, iy=iy);
        layout = makeLayout(ix=ix, iy=iy);
        Plotly.plot('{{ plot.id }}', [trace], layout);
    }

    var default_ix = {% if plot.default_x is defined %} plot_data['index'].indexOf("{{ plot.default_x }}") {% else %} 0 {% endif %};
    var default_iy = {% if plot.default_y is defined %} plot_data['index'].indexOf("{{ plot.default_y }}") {% else %} 1 {% endif %};
    makePlot(ix=default_ix, iy=default_iy);

  });
</script> 
{%- endmacro %}
