from pytest import approx
import json

json_string = """
{
  "level_descriptions": [
    {
      "level_number": 1, 
      "level_name": "chain", 
      "level_type": "tls"
    }, 
    {
      "level_number": 2, 
      "level_name": "sec. struct.", 
      "level_type": "tls"
    } 
  ], 
  "tls_level_data": {
    "chain": {
      "level_number": 1, 
      "level_name": "chain", 
      "tls_group_data": [
        {
          "group_number": 1, 
          "selection": "chain 'A'", 
          "number_of_atoms": 452, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                0.613644398027, 
                0.466923428529, 
                0.9387014908269999, 
                0.070302265928, 
                -0.352823507886, 
                -0.483802209047
              ], 
              "L": [
                16.019517606803, 
                33.860739719953, 
                4.621812225353, 
                11.919792484374, 
                6.786765692427, 
                10.954088467477
              ], 
              "S": [
                1.132386801515, 
                0.201400277269, 
                -2.466304732265, 
                0.997034904258, 
                -0.581053248233, 
                -1.4168125591729999, 
                0.597004744961, 
                -0.105350978204, 
                -0.551333553282
              ], 
              "amplitudes": {
                "1UOY": 0.062881249694
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }
      ]
    }, 
    "sec. struct.": {
      "level_number": 2, 
      "level_name": "sec. struct.", 
      "tls_group_data": [
        {
          "group_number": 1, 
          "selection": "chain 'A' and resid 1  through 18", 
          "number_of_atoms": 132, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                1.37780963893, 
                0.102628868217, 
                0.684349943655, 
                0.018438205133, 
                -0.388473378617, 
                -0.050610250773
              ], 
              "L": [
                9.857348747442, 
                54.969284279593, 
                2.240693875638, 
                -0.902931334375, 
                -4.256333085213, 
                0.854045971318
              ], 
              "S": [
                0.508049794047, 
                0.027053028981, 
                1.766260289222, 
                -1.398953527603, 
                0.446801501061, 
                -1.837395248869, 
                -1.046324649039, 
                0.039393700889, 
                -0.9548512951079999
              ], 
              "amplitudes": {
                "1UOY": 0.054673780909
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }, 
        {
          "group_number": 2, 
          "selection": "chain 'A' and resid 19  through 23", 
          "number_of_atoms": 30, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                1.470182593377, 
                0.370825731807, 
                0.709106356143, 
                -0.117042098442, 
                0.128075355945, 
                -0.325230006881
              ], 
              "L": [
                9.704787800079, 
                9.937161985307, 
                18.321118003147, 
                9.801753630601, 
                0.9186590927639999, 
                0.322952977908
              ], 
              "S": [
                0.6871567172499999, 
                -1.047064478958, 
                -0.52401275951, 
                0.698033646485, 
                -0.928556095415, 
                -0.595985677373, 
                -0.428936267586, 
                -0.011415848023, 
                0.24139937816499998
              ], 
              "amplitudes": {
                "1UOY": 0.048063753106
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }, 
        {
          "group_number": 3, 
          "selection": "chain 'A' and resid 24  through 27", 
          "number_of_atoms": 40, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                1.176429457729, 
                1.510734580413, 
                1.363766331577, 
                -0.026868375017, 
                -1.159752149998, 
                0.05003945421
              ], 
              "L": [
                -0.001723944946, 
                -0.001724659051, 
                0.003631600265, 
                0.001558221209, 
                0.00328262225, 
                0.003282154187
              ], 
              "S": [
                -0.00028403589599999997, 
                -5.6204344e-05, 
                5.3858198999999996e-05, 
                6.9595329999999995e-06, 
                -0.00033178798, 
                -5.4054054e-05, 
                -0.001908730776, 
                0.020114668933, 
                0.000615823876
              ], 
              "amplitudes": {
                "1UOY": 0.019481740363
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }, 
        {
          "group_number": 4, 
          "selection": "chain 'A' and resid 28  through 34", 
          "number_of_atoms": 46, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                0.872169038562, 
                0.738310137784, 
                1.274125111201, 
                -0.127876816103, 
                0.652706753031, 
                0.317741787931
              ], 
              "L": [
                37.64333650156, 
                21.419728757734, 
                7.64028518663, 
                10.462393707482, 
                14.729737820223999, 
                9.980784656495
              ], 
              "S": [
                0.383236481413, 
                -0.286137461537, 
                -1.711899499077, 
                0.207042082735, 
                -0.563466334824, 
                2.197332459475, 
                0.211511221404, 
                -0.30571719483, 
                0.180229853411
              ], 
              "amplitudes": {
                "1UOY": 0.053269133098
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }, 
        {
          "group_number": 5, 
          "selection": "chain 'A' and resid 35  through 40", 
          "number_of_atoms": 42, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                1.072854537014, 
                0.205974244111, 
                0.883444552481, 
                0.142505690277, 
                -0.037818459181, 
                -0.350533984134
              ], 
              "L": [
                32.502302827354, 
                106.126679279495, 
                28.411798856350998, 
                27.921514235741, 
                23.552462287426998, 
                8.251621477023999
              ], 
              "S": [
                -1.10669474332, 
                -1.265135590488, 
                1.747274319965, 
                1.76196658486, 
                -1.938419740024, 
                5.66597633595, 
                -0.5153618432679999, 
                -1.4293412891519999, 
                3.045114483344
              ], 
              "amplitudes": {
                "1UOY": 0.045016555327
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }, 
        {
          "group_number": 6, 
          "selection": "chain 'A' and resid 41  through 46", 
          "number_of_atoms": 50, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                1.023623275666, 
                0.664623841513, 
                1.051993554527, 
                -0.146899665935, 
                0.362101497974, 
                0.23674924196
              ], 
              "L": [
                42.187466979847, 
                21.810749309586, 
                1.4427019508899999, 
                11.718286151699, 
                0.8876760076269999, 
                4.753265827966
              ], 
              "S": [
                -1.5834539302269999, 
                -1.221040179648, 
                2.803007126023, 
                -0.24437385601699999, 
                -0.047644143122, 
                1.776639152476, 
                -0.300904461955, 
                0.129492721911, 
                1.631098073349
              ], 
              "amplitudes": {
                "1UOY": 0.041225638556
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }, 
        {
          "group_number": 7, 
          "selection": "chain 'A' and resid 47  through 64", 
          "number_of_atoms": 112, 
          "tls_modes": [
            {
              "index": 0, 
              "T": [
                0.142936420776, 
                0.62431169885, 
                0.946424463844, 
                -0.022354558884, 
                -0.194477759106, 
                -0.352868455934
              ], 
              "L": [
                27.032576825131, 
                10.994069514269, 
                31.444485587158, 
                -9.095879927498, 
                21.882966519203, 
                0.253104811624
              ], 
              "S": [
                -0.458940916474, 
                -0.466825382015, 
                0.013636974004, 
                -0.40495321734899997, 
                -1.477859571684, 
                1.544305824646, 
                -0.769981212916, 
                -2.071389010777, 
                1.9368004881579999
              ], 
              "amplitudes": {
                "1UOY": 0.048023631053
              }
            }
          ], 
          "tls_origins": {
            "1UOY": [
              4.817814159292037, 
              18.251765486725667, 
              -2.621019911504427
            ]
          }
        }
      ]
    }
  }
}
"""

def test_json_read_and_write(tmpdir):

    from pandemic.adp.json_manager import JsonDataManager

    json_object = json.loads(json_string)

    jsdm = JsonDataManager.from_json(json_string)

    json_file = tmpdir / "test_model_data.json"
    json_file.write(json_string)

    jsdm2 = JsonDataManager.from_json_file(str(json_file))

    assert jsdm.as_json().strip() == jsdm2.as_json().strip()

    js_data = jsdm.model_data

    assert len(js_data['level_descriptions']) == 2

    assert js_data['level_descriptions'][0]["level_number"] == 1
    assert js_data['level_descriptions'][0]["level_name"] == "chain"
    assert js_data['level_descriptions'][0]["level_type"] == "tls"

    assert js_data['level_descriptions'][1]["level_number"] == 2
    assert js_data['level_descriptions'][1]["level_name"] == "sec. struct."
    assert js_data['level_descriptions'][1]["level_type"] == "tls"

    assert js_data['tls_level_data']['sec. struct.']["tls_group_data"][0]["tls_modes"][0]["T"][1] == approx(0.102628868217)

    

